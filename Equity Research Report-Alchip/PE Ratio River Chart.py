import pandas as pd
import matplotlib.pyplot as plt
import yfinance as yf

dates = pd.date_range("2021-01-01", periods=61, freq="MS")

# 抓取股價資料
ticker = "3661.TW"
price = yf.download(ticker, start="2021-01-01", interval="1mo", progress=False)["Close"].squeeze()
price = price.reindex(dates, method="ffill")

# 2021年1月-2026年1月 EPS*本益比倍數
PE29 = [353,353,397.1,397.1,442.1,442,442.1,524.5,524.5,524.6,575.4,575.5,
575.4,575.5,621.8,621.7,642,642,642.1,656.4,656.3,656.3,688.5,688.5,
688.4,688.4,752.3,752.4,802.9,802.8,802.8,925.7,925.7,925.7,1082.9,1082.9,
1082.9,1082.9,1319.9,1319.9,1484.7,1484.8,1484.8,1785.4,1785.4,1785.3,
2115.7,2115.8,2115.9,2115.6,2357.7,2357.5,2437,2436.9,2437,2338,
2338.4,2338,2166.9,2166.7,2166.7]

PE43 = [521.4,521.4,586.6,586.5,653,653,653.1,774.8,774.8,774.8,849.9,850.1,
849.9,850.1,918.4,918.4,948.3,948.3,948.5,969.6,969.5,969.4,1017,1017,
1016.8,1016.9,1111.3,1111.4,1185.9,1185.9,1185.9,1367.4,1367.4,1367.4,1599.6,1599.6,
1599.6,1599.6,1949.7,1949.7,2193.1,2193.3,2193.3,2637.3,2637.3,2637.1,
3125.3,3125.4,3125.5,3125,3482.6,3482.5,3599.9,3599.7,3599.8,3453.6,
3454.2,3453.6,3200.8,3200.6,3200.5]

PE57 = [689.8,689.9,776.1,776,863.9,863.9,864.1,1025.1,1025.1,1025.1,1124.5,1124.6,
1124.5,1124.6,1215.1,1215.1,1254.6,1254.7,1254.9,1282.7,1282.7,1282.6,1345.5,1345.6,
1345.3,1345.4,1470.3,1470.4,1569,1568.9,1569,1809.1,1809.1,1809.1,2116.4,2116.3,
2116.3,2116.3,2579.5,2579.5,2901.5,2901.8,2901.8,3489.3,3489.3,3488.9,
4134.8,4134.9,4135.2,4134.5,4607.6,4607.4,4762.7,4762.5,4762.6,4569.2,
4569.9,4569.1,4234.8,4234.4,4234.3]

PE71 = [858.2,858.3,965.5,965.4,1074.8,1074.8,1075,1275.3,1275.4,1275.4,1399,1399.2,
1399,1399.2,1511.8,1511.8,1561,1561,1561.2,1595.9,1595.9,1595.7,1674,1674.1,
1673.7,1673.9,1829.3,1829.5,1952.1,1952,1952,2250.8,2250.8,2250.8,2633.1,2633,
2633,2633,3209.3,3209.3,3609.9,3610.3,3610.3,4341.2,4341.2,4340.8,
5144.3,5144.5,5144.8,5144,5732.5,5732.3,5925.6,5925.3,5925.4,5684.8,
5685.7,5684.7,5268.7,5268.2,5268.2]

PE85 = [1026.7,1026.7,1155,1154.9,1285.8,1285.7,1286,1525.6,1525.7,1525.7,1673.6,1673.8,
1673.6,1673.8,1808.4,1808.4,1867.3,1867.3,1867.6,1909.1,1909,1908.8,2002.6,2002.6,
2002.2,2002.3,2188.2,2188.5,2335.2,2335.1,2335.1,2692.5,2692.5,2692.5,3149.8,3149.7,
3149.7,3149.7,3839.1,3839.2,4318.3,4318.8,4318.8,5193.1,5193.1,5192.6,
6153.9,6154,6154.4,6153.4,6857.5,6857.2,7088.4,7088.1,7088.2,6800.4,
6801.5,6800.3,6302.7,6302.1,6302]

PE99 = [1195.1,1195.1,1344.5,1344.3,1496.7,1496.7,1497,1775.9,1776,1776,1948.1,1948.4,
1948.1,1948.4,2105.1,2105.1,2173.6,2173.6,2174,2222.3,2222.2,2222,2331.1,2331.1,
2330.6,2330.8,2547.2,2547.5,2718.3,2718.1,2718.1,3134.2,3134.2,3134.2,3666.5,3666.5,
3666.4,3666.5,4468.9,4469,5026.7,5027.3,5027.3,6045,6045,6044.4,
7163.4,7163.6,7164,7162.9,7982.5,7982.1,8251.3,8250.9,8251,7916,
7917.3,7915.9,7336.6,7335.9,7335.9]

df = pd.DataFrame({
    "29.5x": PE29,
    "43.6x": PE43,
    "57.7x": PE57,
    "71.7x": PE71,
    "85.8x": PE85,
    "99.9x": PE99,
    "price": price.values
}, index=dates)


colors = ["#c6dbef","#9ecae1","#6baed6","#3182bd","#08519c"]

plt.figure(figsize=(16,8))

#用不同顏色區分每個本益比區間
for i, (lower, upper) in enumerate([
    ("29.5x","43.6x"),
    ("43.6x","57.7x"),
    ("57.7x","71.7x"),
    ("71.7x","85.8x"),
    ("85.8x","99.9x")
]):
    plt.fill_between(df.index, df[lower], df[upper], color=colors[i], alpha=0.6, label=f"{lower}-{upper}")

# 繪製股價
plt.plot(df.index, df["price"], color="black", linewidth=2, label="AIChip Stock Price")


plt.xlim(df.index[0], df.index[-1])

plt.title("AIChip P/E Ratio River Chart", fontsize=16)
plt.ylabel("Stock Price")
plt.grid(alpha=0.3)
plt.legend()
plt.tight_layout()
plt.show()
